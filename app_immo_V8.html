<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immo-Tracker AI</title>
    <!-- Tailwind CSS pour le style rapide et pro -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome pour les ic√¥nes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Loading Spinner Animation */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div class="max-w-4xl mx-auto p-6">
        
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-blue-600 mb-2"><i class="fa-solid fa-house-chimney"></i> Immo-Tracker AI</h1>
            <p class="text-sm text-gray-500">Extraction intelligente et export vers Google Sheets</p>
        </header>

        <!-- Configuration Section (Collapsible) -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <details>
                <summary class="cursor-pointer font-semibold text-gray-700 hover:text-blue-600 flex justify-between items-center">
                    <span><i class="fa-solid fa-gear"></i> Configuration API</span>
                    <span class="text-xs text-gray-400">(Cl√©s & URLs)</span>
                </summary>
                <div class="mt-4 space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Cl√© API Gemini</label>
                        <input type="password" id="apiKey" class="w-full p-2 border rounded text-sm bg-gray-50 focus:outline-none focus:border-blue-500" value="AIzaSyAiDF3XUooqwZ7ntoIAxo3EiWZ1qyek3bU" placeholder="AIzaSy...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">URL Webhook Google Apps Script</label>
                        <input type="text" id="webhookUrl" class="w-full p-2 border rounded text-sm bg-gray-50 focus:outline-none focus:border-blue-500" value="https://script.google.com/macros/s/AKfycby7WWGLEARGt66z2LXWpn0bxtYF068KWOFAHbSpSYIvnQounRgedagXL9hG00GkzizTtw/exec" placeholder="https://script.google.com/macros/s/.../exec">
                    </div>
                    <button onclick="saveConfig()" class="text-xs text-blue-500 hover:underline">Sauvegarder dans le navigateur</button>
                </div>
            </details>
        </div>

        <!-- Main Interface -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Left Column: Upload & Preview -->
            <div class="md:col-span-1 space-y-4">
                <div class="bg-white p-4 rounded-lg shadow-md text-center transition-all" id="dropZone">
                    <label for="imageInput" class="cursor-pointer block p-6 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
                        <i class="fa-solid fa-layer-group text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm font-medium text-gray-600">Glisser jusqu'√† 5 images</p>
                        <p class="text-xs text-gray-400 mt-1">(Compression auto)</p>
                        <input type="file" id="imageInput" accept="image/*" multiple class="hidden" onchange="handleImageUpload(event)">
                    </label>
                </div>
                
                <!-- Zone de pr√©visualisation grille -->
                <div id="previewContainer" class="hidden">
                    <div class="flex justify-between items-center mb-2 px-1">
                        <span class="text-xs font-bold text-gray-500 uppercase">Aper√ßu</span>
                        <button onclick="clearImages()" class="text-xs text-red-500 hover:text-red-700 cursor-pointer">Tout effacer</button>
                    </div>
                    <div id="previewGrid" class="grid grid-cols-3 gap-2">
                        <!-- Les vignettes seront inject√©es ici par JS -->
                    </div>
                </div>

                <!-- Manual URL Input -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Lien de l'annonce</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                            <i class="fa-solid fa-link text-gray-400 text-xs"></i>
                        </div>
                        <input type="text" id="manualUrl" class="w-full p-2 pl-8 border rounded text-sm focus:border-blue-500 focus:outline-none" placeholder="Lien Jinka, SeLoger... pour extraction">
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1 italic">Pour Jinka, le syst√®me tentera de lire le contenu HTML via un proxy.</p>
                </div>

                <!-- Raw Text Input -->
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Texte Brut</label>
                    <textarea id="rawTextInput" rows="4" class="w-full p-2 border rounded text-sm bg-gray-50 focus:outline-none focus:border-blue-500" placeholder="OU copiez ici le texte brut de l'annonce..."></textarea>
                </div>

                <button id="analyzeBtn" onclick="processContent()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Analyser avec IA
                </button>
            </div>

            <!-- Right Column: Results Form -->
            <div class="md:col-span-2">
                <div id="loadingState" class="hidden flex flex-col items-center justify-center h-full min-h-[300px]">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    <p class="text-gray-500 text-sm animate-pulse mt-4 text-center">Gemini analyse les donn√©es...<br><span class="text-xs text-gray-400">(Tentative d'extraction HTML + IA)</span></p>
                </div>

                <form id="resultForm" class="bg-white p-6 rounded-lg shadow-md hidden" onsubmit="submitToGoogleSheet(event)">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h2 class="text-lg font-bold text-gray-800">R√©sultats</h2>
                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full"><i class="fa-solid fa-check"></i> Pr√™t √† valider</span>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Date</label>
                            <input type="text" id="date" name="date" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Ville</label>
                            <input type="text" id="ville" name="ville" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-gray-500 mb-1">Quartier / M√©tro</label>
                            <input type="text" id="quartier" name="quartier" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors" placeholder="Ex: Marais, M√©tro Bastille">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Prix (‚Ç¨)</label>
                            <input type="number" id="prix" name="prix" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Surface (m¬≤)</label>
                            <input type="number" step="0.1" id="surface" name="surface" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs text-gray-500 mb-1">Type Vendeur</label>
                        <select id="type_vendeur" name="type_vendeur" class="w-full p-2 border rounded bg-gray-50">
                            <option value="Agence">Agence</option>
                            <option value="Particulier">Particulier</option>
                            <option value="Autre">Autre</option>
                        </select>
                    </div>

                    <!-- Nouveaux Champs: Email & T√©l√©phone -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1"><i class="fa-solid fa-at"></i> Email</label>
                            <input type="email" id="email" name="email" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors" placeholder="email@exemple.com">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1"><i class="fa-solid fa-phone"></i> T√©l√©phone</label>
                            <input type="text" id="telephone" name="telephone" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors" placeholder="06...">
                        </div>
                    </div>

                    <div class="mb-6 relative">
                        <div class="flex justify-between items-end mb-1">
                            <label class="block text-xs text-gray-500">Brouillon Message</label>
                            <div class="flex gap-2">
                                <button type="button" onclick="copyMessage()" class="text-xs bg-gray-50 text-gray-600 px-2 py-1 rounded hover:bg-gray-100 transition-colors border border-gray-200" title="Copier le message">
                                    <i class="fa-regular fa-copy"></i> Copier
                                </button>
                                <button type="button" onclick="generateMessage()" id="genMsgBtn" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100 transition-colors border border-blue-200">
                                    <i class="fa-solid fa-robot"></i> G√©n√©rer un message personnalis√©
                                </button>
                            </div>
                        </div>
                        <textarea id="message_draft" name="message_draft" rows="8" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors text-sm"></textarea>
                    </div>

                    <!-- Toggle: Cr√©er Brouillon Gmail -->
                    <div class="mb-6 bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="bg-red-100 p-2 rounded-full text-red-600 w-8 h-8 flex items-center justify-center">
                                <i class="fa-brands fa-google"></i>
                            </div>
                            <div>
                                <label for="createDraft" class="block text-sm font-semibold text-gray-700 cursor-pointer select-none">Envoyer l'email automatiquement?</label>
                                <p class="text-[10px] text-gray-500">Objet : "Demande de visite - achat - [Ville/Quartier]"</p>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="createDraft" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>

                    <!-- Nouveau Champ: Suivi de candidature -->
                    <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <label class="block text-xs font-bold text-blue-800 mb-2 uppercase">Suivi de candidature</label>
                        <select id="status" name="status" class="w-full p-2 border border-blue-300 rounded bg-white text-blue-900 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <option value="Non">üî¥ Non (Pas encore contact√©)</option>
                            <option value="A contacter" selected>üü† √Ä contacter</option>
                            <option value="Contact√©">üü¢ Contact√©</option>
                        </select>
                    </div>

                    <!-- Nouveau Champ: Commentaire -->
                    <div class="mb-6">
                        <label class="block text-xs text-gray-500 mb-1">Un commentaire ?</label>
                        <textarea id="commentaire" name="commentaire" rows="2" class="w-full p-2 border rounded bg-gray-50 focus:bg-white transition-colors text-sm" placeholder="Notes personnelles..."></textarea>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow flex justify-center items-center gap-2">
                        <i class="fa-regular fa-paper-plane"></i> Envoyer vers Google Sheets
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 hidden bg-gray-800 text-white px-4 py-3 rounded shadow-lg transition-opacity duration-300 opacity-0 z-50">
        <span id="toastMsg">Message</span>
    </div>

    <script>
        // --- State & Config ---
        // Modification: Tableau pour stocker plusieurs images
        let currentBase64Images = [];
        
        // Load config on startup
        window.addEventListener('load', () => {
            const localKey = localStorage.getItem('immo_gemini_key');
            const localUrl = localStorage.getItem('immo_webhook_url');
            if (localKey) document.getElementById('apiKey').value = localKey;
            if (localUrl) document.getElementById('webhookUrl').value = localUrl;
        });

        function saveConfig() {
            localStorage.setItem('immo_gemini_key', document.getElementById('apiKey').value);
            localStorage.setItem('immo_webhook_url', document.getElementById('webhookUrl').value);
            showToast("Configuration sauvegard√©e", "success");
        }

        function clearImages() {
            currentBase64Images = [];
            document.getElementById('imageInput').value = '';
            document.getElementById('previewGrid').innerHTML = '';
            document.getElementById('previewContainer').classList.add('hidden');
        }

        // --- Image Compression & Handling (Robust Function) ---
        function resizeImage(file, maxWidth = 1024, maxHeight = 1024) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Compression JPEG 80%
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(dataUrl.split(',')[1]); // Retourne uniquement le base64
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        async function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            // Limite √† 5 images
            const maxImages = 5;
            const filesToProcess = files.slice(0, maxImages);
            if (files.length > maxImages) {
                showToast(`Maximum ${maxImages} images. Seules les premi√®res sont conserv√©es.`, "warning");
            }

            // UI Reset
            clearImages();
            document.getElementById('previewContainer').classList.remove('hidden');
            const grid = document.getElementById('previewGrid');

            // Traitement asynchrone s√©curis√©
            for (const file of filesToProcess) {
                try {
                    // Cr√©ation placeholder visuel
                    const div = document.createElement('div');
                    div.className = "relative aspect-square bg-gray-100 rounded overflow-hidden border border-gray-200 animate-pulse";
                    grid.appendChild(div);

                    // Compression et encodage
                    const base64 = await resizeImage(file);
                    currentBase64Images.push(base64);

                    // Mise √† jour visuelle (remplace le placeholder)
                    const img = document.createElement('img');
                    img.src = "data:image/jpeg;base64," + base64;
                    img.className = "w-full h-full object-cover";
                    div.innerHTML = ''; // vide le placeholder
                    div.appendChild(img);
                    div.classList.remove('animate-pulse');
                    
                } catch (error) {
                    console.error("Erreur compression image", error);
                    showToast("Erreur lors du traitement d'une image", "error");
                }
            }
        }

        // --- Fetch HTML via Proxy for Jinka/Hard links ---
        async function fetchUrlContent(url) {
            try {
                // Utilisation de allorigins.win comme proxy pour contourner CORS et r√©cup√©rer le HTML
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) return null;
                const data = await response.json();
                return data.contents; // Contient le HTML brut
            } catch (e) {
                console.warn("√âchec proxy:", e);
                return null;
            }
        }

        // --- Gemini AI Logic ---
        async function processContent() {
            const apiKey = document.getElementById('apiKey').value;
            const rawText = document.getElementById('rawTextInput').value;
            const urlInput = document.getElementById('manualUrl').value;
            
            // Validation multi-source
            const hasImages = currentBase64Images.length > 0;
            const hasText = rawText.trim().length > 0;
            const hasUrl = urlInput.trim().length > 0;

            if (!apiKey || (!hasImages && !hasText && !hasUrl)) {
                showToast("Erreur: Fournissez une Cl√© API et au moins une source (Image, Lien ou Texte)", "error");
                return;
            }

            // UI Loading
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('resultForm').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = true;

            const basePrompt = `
            Agis comme un expert immobilier. Analyse les informations fournies (Images, Texte ou URL).
            Extrais les informations au format JSON strict (pas de markdown) :
            {
                "date": "YYYY-MM-DD (ou date du jour si absent)",
                "ville": "Ville ou code postal",
                "quartier": "Quartier pr√©cis ou m√©tro le plus proche",
                "prix": "Entier sans devise",
                "surface": "Float (m2)",
                "type_vendeur": "Agence ou Particulier",
                "email": "Adresse email de contact si pr√©sente (sinon null)",
                "telephone": "Num√©ro de t√©l√©phone si pr√©sent (sinon null)"
            }
            Si inconnu, mets null ou 0.`;

            // Construction dynamique du contenu
            const parts = [{ "text": basePrompt }];
            
            // Gestion avanc√©e de l'URL (Jinka / Proxy / Search)
            if (hasUrl) {
                let htmlContent = null;
                if (urlInput.includes('jinka') || urlInput.includes('seloger')) {
                    try {
                       htmlContent = await fetchUrlContent(urlInput);
                    } catch(err) { console.log("Proxy error ignored"); }
                }

                if (htmlContent) {
                    const truncatedHtml = htmlContent.substring(0, 30000);
                    parts.push({ "text": "Voici le contenu HTML brut de la page cible (Analyse ce code pour extraire les infos) : \n" + truncatedHtml });
                } else {
                    parts.push({ "text": "Voici l'URL de l'annonce. Utilise Google Search pour trouver les d√©tails (prix, surface, lieu, contact) de cette page sp√©cifique : " + urlInput });
                }
            }

            if (hasText) {
                parts.push({ "text": "Voici le texte brut de l'annonce : \n" + rawText });
            }
            
            // Ajout dynamique des images (multimodal)
            if (hasImages) {
                currentBase64Images.forEach(base64 => {
                    parts.push({ 
                        "inline_data": { 
                            "mime_type": "image/jpeg", 
                            "data": base64 
                        } 
                    });
                });
            }

            const payload = {
                "contents": [{
                    "parts": parts
                }],
                // Activation de Google Search Grounding pour le "light scraping"
                "tools": [{ "google_search": {} }]
            };

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                // Parsing Gemini response
                if (data.candidates && data.candidates[0].content) {
                    const responseText = data.candidates[0].content.parts[0].text;
                    const jsonStr = responseText.replace(/```json|```/g, '').trim(); // Basic cleanup
                    
                    // Find JSON object boundaries robustly
                    const jsonStart = jsonStr.indexOf('{');
                    const jsonEnd = jsonStr.lastIndexOf('}') + 1;
                    
                    if (jsonStart !== -1 && jsonEnd !== -1) {
                        const cleanJson = JSON.parse(jsonStr.substring(jsonStart, jsonEnd));
                        populateForm(cleanJson);
                    } else {
                        throw new Error("Pas de JSON valide trouv√© dans la r√©ponse");
                    }
                } else {
                    throw new Error("R√©ponse Gemini vide ou invalide");
                }

            } catch (error) {
                console.error(error);
                showToast("Erreur lors de l'analyse IA: " + error.message, "error");
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        async function generateMessage() {
            const apiKey = document.getElementById('apiKey').value;
            const quartier = document.getElementById('quartier').value || document.getElementById('ville').value || "votre quartier";
            const btn = document.getElementById('genMsgBtn');
            const textarea = document.getElementById('message_draft');

            if (!apiKey) {
                showToast("Cl√© API manquante", "error");
                return;
            }

            // UI Loading
            const originalBtnText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> R√©daction...';
            btn.disabled = true;

            // Template sp√©cifique Robin
            const templateRequest = `
            Tu es un assistant personnel. G√©n√®re un message pour un vendeur immobilier en utilisant EXACTEMENT ce mod√®le ci-dessous.
            Ta seule t√¢che est de remplacer "[Rue ou Quartier]" par "${quartier}" de mani√®re naturelle.
            Ne change pas les autres informations (Robin, 24 ans, ing√©nieur, etc.).

            MOD√àLE :
            Bonjour,
            J'ai vu votre annonce concernant la vente de votre appartement situ√© [Rue ou Quartier] et je suis tr√®s int√©ress√©.
            Je m'appelle Robin, j'ai 24 ans et je suis ing√©nieur. Je connais bien le quartier et cherche √† acheter pour y habiter.
            Pour vous rassurer sur le s√©rieux de ma d√©marche :
            Mon dossier de financement est d√©j√† √©tudi√© et valid√© (capacit√© : 250k‚Ç¨).
            Je n'ai pas de condition suspensive de vente d'un autre bien.
            Je peux me rendre disponible rapidement pour une visite selon vos disponibilit√©s.
            Serait-il possible de convenir d'un cr√©neau ?
            Merci d'avance,
            Robin Sarriaud
            0610980100
            robin.sarriaud@gmail.com
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "contents": [{ "parts": [{ "text": templateRequest }] }]
                    })
                });

                const data = await response.json();
                
                if (data.candidates && data.candidates[0].content) {
                    textarea.value = data.candidates[0].content.parts[0].text.trim();
                    showToast("Message g√©n√©r√© !", "success");
                }

            } catch (error) {
                console.error(error);
                showToast("Erreur g√©n√©ration message", "error");
            } finally {
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
            }
        }

        // --- Copy to Clipboard Utility ---
        function copyMessage() {
            const textarea = document.getElementById('message_draft');
            if (!textarea.value) {
                showToast("Aucun message √† copier", "error");
                return;
            }
            
            textarea.select();
            // Utilisation de execCommand pour compatibilit√© iframe robuste
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast("Message copi√© !", "success");
                } else {
                    showToast("Erreur lors de la copie", "error");
                }
            } catch (err) {
                showToast("Impossible de copier", "error");
            }
            // Nettoyage de la s√©lection
            window.getSelection().removeAllRanges();
        }

        function populateForm(data) {
            document.getElementById('date').value = data.date || new Date().toISOString().split('T')[0];
            document.getElementById('ville').value = data.ville || '';
            document.getElementById('quartier').value = data.quartier || '';
            document.getElementById('prix').value = data.prix || 0;
            document.getElementById('surface').value = data.surface || 0;
            document.getElementById('type_vendeur').value = data.type_vendeur === 'Particulier' ? 'Particulier' : 'Agence';
            document.getElementById('email').value = data.email || '';
            document.getElementById('telephone').value = data.telephone || '';
            // Le message draft est laiss√© vide intentionnellement pour √™tre g√©n√©r√© √† la demande
            document.getElementById('message_draft').value = '';
            
            document.getElementById('resultForm').classList.remove('hidden');
            // Scroll to form
            document.getElementById('resultForm').scrollIntoView({ behavior: 'smooth' });
        }

        // --- Google Sheets Webhook Logic ---
        async function submitToGoogleSheet(e) {
            e.preventDefault();
            const webhookUrl = document.getElementById('webhookUrl').value;
            const submitBtn = document.getElementById('submitBtn');

            if (!webhookUrl) {
                showToast("Veuillez configurer l'URL du Webhook", "error");
                return;
            }

            // UI Loading
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Envoi...';
            submitBtn.disabled = true;

            const formData = {
                date: document.getElementById('date').value,
                ville: document.getElementById('ville').value,
                quartier: document.getElementById('quartier').value,
                prix: parseFloat(document.getElementById('prix').value),
                surface: parseFloat(document.getElementById('surface').value),
                url: document.getElementById('manualUrl').value, 
                type_vendeur: document.getElementById('type_vendeur').value,
                email: document.getElementById('email').value, 
                telephone: document.getElementById('telephone').value, 
                status: document.getElementById('status').value, 
                commentaire: document.getElementById('commentaire').value,
                create_draft: document.getElementById('createDraft').checked, // Instruction Brouillon
                message_draft: document.getElementById('message_draft').value
            };

            try {
                // IMPORTANT: On utilise fetch avec no-cors ou text/plain pour √©viter les erreurs CORS de GAS
                // Note : GAS ne g√®re pas bien le Preflight OPTIONS header 'application/json'.
                // On envoie donc une cha√Æne JSON mais sans le header Content-Type application/json
                
                await fetch(webhookUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Hack pour √©viter le blocage navigateur vers GAS
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8',
                    },
                    body: JSON.stringify(formData)
                });

                // En mode no-cors, on ne peut pas lire la r√©ponse, on suppose le succ√®s si pas d'erreur r√©seau
                showToast("Donn√©es envoy√©es avec succ√®s !", "success");
                
                // Reset partiel
                document.getElementById('resultForm').classList.add('hidden');
                clearImages();
                document.getElementById('rawTextInput').value = ''; // Reset text input too
                document.getElementById('commentaire').value = ''; // Reset commentaire
                // Reset du switch brouillon √† false
                document.getElementById('createDraft').checked = false;

            } catch (error) {
                console.error(error);
                showToast("Erreur d'envoi vers Sheets", "error");
            } finally {
                submitBtn.innerHTML = '<i class="fa-regular fa-paper-plane"></i> Envoyer vers Google Sheets';
                submitBtn.disabled = false;
            }
        }

        // --- Toast Utility ---
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            const toastMsg = document.getElementById('toastMsg');
            
            toast.className = `fixed bottom-5 right-5 px-4 py-3 rounded shadow-lg transition-opacity duration-300 z-50 text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`;
            toastMsg.innerText = message;
            
            toast.classList.remove('hidden');
            // Petit hack pour forcer le reflow et l'animation
            setTimeout(() => toast.classList.remove('opacity-0'), 10);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }
    </script>
</body>
</html>